<!DOCTYPE html>

<html>

    <head>
        <title>Search</title>
        <link rel="stylesheet" type="text/css" href="../css/main.css" />

        <script src="../scripts/external/numeral.min.js"></script>
        <script src="../scripts/config.js"></script>
        <script src="../scripts/common.js"></script>
        <script src="../scripts/util.js"></script>
    </head>

    <body>
        <script>
            init().then(async () => {
                const content = document.getElementById('content')
                const query = sanitizeInput(parseQuery(window.location).get('query'))

                if (!query) {
                    content.innerText = "The query URL param is missing!"
                    return
                }
                const trackRequest = makeRequest(`tracks/search`, { query: query })
                const playlistRequest = makeRequest(`playlists/search`, { query: query })
                const userRequest = makeRequest(`users/search`, { query: query })

                const results = await Promise.allSettled([trackRequest, playlistRequest, userRequest])
                window.results = results

                const [trackResult, playlistResult, userResult] = results

                // build the result divs
                content.innerHTML = `
                    <h3>Tracks</h3>
                    <div id="tracks" class="searchcontent row"></div>
                    <h3>Playlists</h3>
                    <div id="playlists" class="searchcontent row"></div>
                    <h3>Users</h3>
                    <div id="users" class="searchcontent row"></div>
                `

                const tracksDiv = document.getElementById('tracks')
                const playlistsDiv = document.getElementById('playlists')
                const usersDiv = document.getElementById('users')

                if (trackResult.status === "fulfilled") {
                    const tracks = (await trackResult.value.json()).data
                    for (const track of tracks) {
                        const elmstr = `
                            <div class="contentcard minicontentcard">
                                <div class="artworkcontainer">
                                    <img class="artwork" src="${track.artwork['480x480']}" />
                                </div>
                                <div class="cardmaincontent">
                                    <div class="contenttitle">
                                        <a id="track-${track.id}" href="./track.html?track=${track.id}"><span class="title">${track.title}</span></a>
                                        <a id="artist-${track.user.handle}" href="./artist.html?artist=${track.user.handle}">
                                            <span class="artistname">${track.user.name}</span>
                                        </a>
                                    </div>
                                    <div class="contentinfo">
                                        <span class="stats">${buildTimestamp(track.duration)}</span>
                                        <span class="stats">${numeral(track.play_count).format()} plays</span>
                                        <span class="stats">${numeral(track.favorite_count).format()} favorites</span>
                                        <span class="stats">${numeral(track.repost_count).format()} reposts</span>
                                    </div>
                                </div>
                            </div>
                        `
                        tracksDiv.innerHTML += elmstr
                    }
                }
            })
        </script>
    </body>

</html>